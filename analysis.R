{ #execute entire script

#### LIBRARYS ####
{
  library(MASS)
  library(gofcat)
  library(tibble)
  library(dplyr)
  library(ggplot2)
  library(scales)
  library(ordinal)
}

setwd(dirname(rstudioapi::getSourceEditorContext()$path))

#### CONSTANTS ####
{
  fragility_data = 'data/fragility_dataset.csv'
  damagetoloss_data = 'data/damagetoloss_dataset.csv'
  vulnerability_data = 'data/vulnerability_dataset.csv'
  confidence_level <- 0.95
  dmg_classes = c("None", "Slight","Moderate","Extensive","Complete")
  casualty_classes <- c("Survived", "Died")
  data_seq <- c(seq(0.001, 0.99, by = 0.001), seq(1, 999, by = 0.5), seq(1000, 10000, by = 10))
  bootstrap_iterations <- 100
}


#### HELPERS ####
resample_data <- function(dataframe) {
  result <- data.frame()
  for (i in 1:nrow(dataframe)) {
    row <- sample_n(dataframe,1)
    result <- rbind(result,row)
  } 
  return(result)
}

#### GET AND PREP DATA ####
{
  d2ldata <- read.csv(file = damagetoloss_data)
  fdata <- read.csv(file = fragility_data)
  fdata$dmgcat <- ordered(fdata$Structural_Damage_State, levels = dmg_classes) #store damage category as a factor
  fdata$logIP <- log10(fdata$Impact_Pressure)
}

#### GENERATE VULNERABILITY DATASET ####
{
  vdata <- merge(d2ldata, fdata, by = "Building_Name")
  vdata <- vdata[,c("Building_Name", "Structural_Damage_State.y", "Fatality", "Depth", "Velocity", "Impact_Pressure")]
  colnames(vdata)[which(names(vdata) == "Structural_Damage_State.y")] <- "Structural_Damage_State"
  write.csv(vdata, vulnerability_data, row.names=FALSE)
  vdata$logIP <- log10(vdata$Impact_Pressure)
  vdata$Fatality_Description <- ordered(if_else(vdata$Fatality == '0',"Survived","Died"), levels = casualty_classes)
  vdata_complete <- vdata[vdata$Structural_Damage_State == "Complete",] #filter for completely damaged buildings
}

#### GENERATE VULNERABILITY CURVES ####
{
vulnerability_curves = data.frame(Impact_Pressure = data_seq)
for(x in 1:bootstrap_iterations) { #bootstrap data to find prediction intervals
  print(x)
  
  #### RESAMPLE DATA ####
  if (x == 1) { #mean curve
    d2ldata_resample <- d2ldata
    fdata_resample <- fdata
    vdata_resample <- vdata_complete
  } else { #curves for confidence intervals
    d2ldata_resample <- resample_data(d2ldata)
    fdata_resample <- resample_data(fdata)
    vdata_resample <- resample_data(vdata_complete)
  }
  
  #### GENERATE FRAGILITY CURVES ####
  {
    #linked ordinal regression
    m_fragility <-  clm(dmgcat ~ logIP, data = fdata_resample, link = "probit", Hess = TRUE)
    
    #create dataframe where curves are stored
    fragility_curves = data.frame(Impact_Pressure = data_seq)
    fragility_curves <- mutate(fragility_curves, logIP = log10(Impact_Pressure))
    
    #calculate prob. of exceeding each damage state
    preds <- predict(m_fragility, newdata = fragility_curves, type = "linear.predictor")
    preds <- as.data.frame(preds[[1]])
    for(col in 1:ncol(preds)){
      col_name = paste('PoE',dmg_classes[col],sep="")
      preds[col_name] <- pnorm(preds[,col], lower.tail = FALSE)
    }
    
    #calculate associated probability of damage state
    for (i in 1:length(dmg_classes)) {
      dmg_class = dmg_classes[i]
      col_name = paste('P',dmg_class,sep="")
      if (dmg_class == "None") {
        preds[col_name] <- 1 - preds$PoENone   
      } else if (dmg_class == "Complete") {
        preds[col_name] <- preds$PoEExtensive
      } else {
        preds[col_name] <- preds[(i+5)-1] - preds[i+5]
      }}
    
    fragility_curves <- cbind(fragility_curves, preds[,6:length(preds)])
    fragility_curves <- fragility_curves[,!(names(fragility_curves) %in% c("logIP","PoEComplete"))]
    
  }
  
  #### GENERATE DAMAGETOLOSS MODEL ####
  {
    #calculate prob. of death for each damage state
    damagetoloss <- d2ldata_resample %>% group_by(Structural_Damage_State) %>%
      summarise(fatalities = sum(Fatality),
                survivors = sum(NonFatality))
    damagetoloss$fatalityRate <- (damagetoloss$fatalities / (damagetoloss$fatalities + damagetoloss$survivors)) 
    
    #reformat data
    damagetoloss <- as.data.frame(damagetoloss) 
    rownames(damagetoloss) <- damagetoloss$Structural_Damage_State
  }
  
  #### GENERATE VULNERABILITY CURVE FOR COMPLETE DAMAGE STATE ####
  {
    #logistic regression
    m_logIP <- glm(Fatality_Description ~ logIP, data = vdata_resample, family = "binomial") 
    
    #create curves
    vcurve = data.frame(Impact_Pressure = data_seq)
    vcurve <- mutate(vcurve, logIP=log10(Impact_Pressure))
    vcurve$PFatality_CompleteDamage <- predict(m_logIP, newdata = vcurve, type = "response")
    vcurve <- vcurve[,!(names(vcurve) %in% c("logIP"))]
  }
  
  #### GENERATE VULNERABILITY CURVE ####
  col_name = paste(x)
  vulnerability_curves[col_name] <- fragility_curves$PNone*damagetoloss['None','fatalityRate'] +
    fragility_curves$PSlight*damagetoloss['Slight','fatalityRate'] +
    fragility_curves$PModerate*damagetoloss['Moderate','fatalityRate'] +
    fragility_curves$PExtensive*damagetoloss['Extensive','fatalityRate'] +
    fragility_curves$PComplete*vcurve$PFatality_CompleteDamage
  
  if (x == 1) { #export mean curves
    write.csv(fragility_curves, "models/fragility_model.csv", row.names=FALSE)
    write.csv(damagetoloss, "models/damagetoloss_model.csv", row.names=FALSE)
    write.csv(vcurve, "models/vulnerability_completedamage_model.csv", row.names=FALSE)
  }
}
}

#### FIND THE 95th CONFIDENCE INTERVAL ####
{
lwrCI <- apply(vulnerability_curves[,2:ncol(vulnerability_curves)], 1, quantile, probs = (1 - confidence_level))
uprCI <- apply(vulnerability_curves[,2:ncol(vulnerability_curves)], 1, quantile, probs = confidence_level)
vulnerability_model <- as.data.frame(cbind(Impact_Pressure = data_seq, PFatality_MeanCurve = vulnerability_curves$'1', PFatality_lwrCI = lwrCI, PFatality_uprCI = uprCI))
write.csv(vulnerability_model, "models/vulnerability_model.csv", row.names=FALSE)
}

#### GENERATE PLOTS ####
{ 
  breaks <- 10^pretty(log10(seq(0.1,10000,10)))
  minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))
  line_width = 1 #for plotting
  alpha = 0.2 #for plotting
  colors <- c("Slight" = "#e7e706", "Moderate" = "#fecc5c", "Extensive" = "#fd8d3c", "Complete" = "#e31a1c") #for plotting

  #### GENERATE FRAGILITY PLOT ####
  fragility_model <- read.csv(file = "models/fragility_model.csv")    
  fragility_plt <- ggplot(data = fragility_model, aes(x=Impact_Pressure)) +
    geom_line(aes(y = fragility_model[,2], color = names(colors)[1]), linewidth = line_width) +
    geom_line(aes(y = fragility_model[,3], color = names(colors)[2]), linewidth = line_width) +
    geom_line(aes(y = fragility_model[,4], color = names(colors)[3]), linewidth = line_width) +
    geom_line(aes(y = fragility_model[,5], color = names(colors)[4]), linewidth = line_width) +
    labs(x = 'Impact Pressure (kPa)', y = 'Probability of Exceeding Damage State', color = NULL) +
    scale_x_continuous(expand = c(0, 0), limits = c(0.1,10000), trans = 'log10', breaks = breaks, minor_breaks = minor_breaks, labels = label_comma()) + 
    scale_y_continuous(expand = c(0, 0), limits = c(0,1), breaks = c(seq(0,1,0.1))) +
    theme_linedraw() +
    scale_color_manual(values = colors) +
    theme(legend.position = "bottom") +
    guides(color = guide_legend(reverse = TRUE))

  #### GENERATE VULNERABILITY PLOT ####
  vulnerability_plt <- ggplot(data = vulnerability_model, aes(x=Impact_Pressure)) +
    geom_line(aes(y = vulnerability_model[,2]), linewidth = line_width) +
    geom_ribbon(aes(ymin = vulnerability_model[,3], ymax = vulnerability_model[,4]), fill = colors[4], alpha = alpha) +
    geom_point(data = vdata, aes(y = vdata[,3]), shape = 1, color = "black", size = 4) +
    labs(x = 'Impact Pressure (kPa)', y = 'Probability of Fatality', color = NULL) +
    scale_x_continuous(expand = c(0, 0), limits = c(0.1,10000), trans = 'log10', breaks = breaks, minor_breaks = minor_breaks, labels = label_comma()) + 
    scale_y_continuous(expand = c(0, 0), limits = c(0,1), breaks = c(seq(0,1,0.1))) +
    theme_linedraw() +
    theme(legend.position = "bottom") +
    guides(color = guide_legend(reverse = TRUE))
vulnerability_plt
  
#export plots
ggsave("models/fragility_model.png", fragility_plt)  
ggsave("models/vulnerability_model.png", vulnerability_plt)
}

}
